<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="indi.aby.docm.core.contract.DocmMapper">
    <resultMap id="DocmEntity" type="indi.aby.docm.core.contract.DocmEntity"
               extends="indi.rui.common.web.dao.IMapper.AbstractData">
        <result column="project_name" property="projectName"/>
        <result column="project_type" property="projectType"/>
        <result column="company" property="company"/>
        <result column="contract_num" property="contractNum"/>
        <result column="contract_time" property="contractTime"/>
        <result column="credential_num" property="credentialNum"/>
        <result column="credential_time" property="credentialTime"/>
        <result column="money" property="money"/>
        <association column="dept" property="dept" resultMap="indi.aby.docm.core.account.UserMapper.DeptVO"/>
        <collection notNullColumn="attachment_id" property="attachments" ofType="indi.aby.docm.api.contract.AttachmentVO"
                    resultMap="AttachmentVO"/>
    </resultMap>
    <resultMap id="AttachmentVO" type="indi.aby.docm.api.contract.AttachmentVO"
               extends="indi.rui.common.web.dao.IMapper.AbstractData">
        <id column="attachment_id" property="id"/>
        <result column="docm_id" property="docmId"/>
        <result column="doc_path" property="docPath"/>
        <result column="doc_name" property="docName"/>
    </resultMap>

    <insert id="add">
        insert into t_docm (id, name, project_name,
        project_type, company, contract_num,
        contract_time, credential_num, credential_time,
        money, dept_id)
        values (#{id}, #{name}, #{projectName},
        #{projectType}, #{company}, #{contractNum},
        #{contractTime}, #{credentialNum}, #{credentialTime},
        #{money}, #{dept.id})
    </insert>
    <update id="update">
        update t_docm
        <set>
            <if test="projectName != null || nullAbles.projectName">
                project_name = #{projectName},
            </if>
            <if test="projectType != null || nullAbles.projectType">
                project_type = #{projectType},
            </if>
            <if test="company != null || nullAbles.company">
                company = #{company},
            </if>
            <if test="contractNum != null || nullAbles.contractNum">
                contract_num = #{contractNum},
            </if>
            <if test="contractTime != null || nullAbles.contractTime">
                contract_time = #{contractTime},
            </if>
            <if test="credentialNum != null || nullAbles.credentialNum">
                credential_num = #{credentialNum},
            </if>
            <if test="credentialTime != null || nullAbles.credentialTime">
                credential_time = #{credentialTime},
            </if>
            <if test="money != null || nullAbles.money">
                money = #{money},
            </if>
            <choose>
                <when test="nullAbles.dept">
                    <choose>
                        <when test="dept != null">
                            dept_id = #{dept.id},
                        </when>
                        <otherwise>
                            dept_id = null,
                        </otherwise>
                    </choose>
                </when>
                <otherwise>
                    <if test="dept != null and dept.id != null">
                        dept_id = #{dept.id},
                    </if>
                </otherwise>
            </choose>
        </set>
        where id = #{id}
    </update>
    <select id="findTotalNum" resultType="java.lang.Integer">
        select count(docm.id)
        from t_docm docm
        left join t_dept dept on docm.dept_id = dept.id
        where docm.state = '1'
        <if test="conditions.keywords != null and conditions.keywords.size > 0">
            and(
            <foreach collection="conditions.keywords" open="(" close=")" item="keyword" separator="and">
                docm.project_name like '%${keyword}%'
            </foreach>
            ||
            <foreach collection="conditions.keywords" open="(" close=")" item="keyword" separator="and">
                docm.company like '%${keyword}%'
            </foreach>
            )
        </if>
        <if test="conditions.projectType != null">
            and docm.project_type = #{conditions.projectType}
        </if>
        <if test="conditions.dept != null and conditions.dept.id != null">
            and docm.dept_id = #{conditions.dept.id}
        </if>
    </select>
    <select id="findAll" resultMap="DocmEntity">
        select sub.*, attachment.id attachment_id, attachment.docm_id, attachment.doc_path, attachment.doc_name
        from (
            select docm.*, dept.name dept_name
            from t_docm docm
            left join t_dept dept on docm.dept_id = dept.id
            where docm.state = '1'
            <if test="conditions.keywords != null and conditions.keywords.size > 0">
                and(
                <foreach collection="conditions.keywords" open="(" close=")" item="keyword" separator="and">
                    docm.project_name like '%${keyword}%'
                </foreach>
                ||
                <foreach collection="conditions.keywords" open="(" close=")" item="keyword" separator="and">
                    docm.company like '%${keyword}%'
                </foreach>
                )
            </if>
            <if test="conditions.projectType != null">
                and docm.project_type = #{conditions.projectType}
            </if>
            <if test="conditions.dept != null and conditions.dept.id != null">
                and docm.dept_id = #{conditions.dept.id}
            </if>
            order by
            <choose>
                <when test="sorters.size > 0">
                    <foreach collection="sorters.entrySet()" index="key" item="value">
                        docm.${key} ${value}
                    </foreach>
                </when>
                <otherwise>
                    docm.create_time desc
                </otherwise>
            </choose>
            limit #{offset}, #{pageSize}) as sub
        left join t_attachment attachment on sub.id = attachment.docm_id
        order by
        <choose>
            <when test="sorters.size > 0">
                <foreach collection="sorters.entrySet()" index="key" item="value">
                    sub.${key} ${value}
                </foreach>
            </when>
            <otherwise>
                sub.create_time desc
            </otherwise>
        </choose>
    </select>
    <select id="findById" resultMap="DocmEntity">
        select *, dept.name dept_name, attachment.id attachment_id
        from t_docm docm
        left join t_dept dept on docm.dept_id = dept.id
        left join t_attachment attachment on docm.id = attachment.docm_id
        where docm.id = #{id}
    </select>
    <select id="findAllType" resultType="java.lang.String">
        select project_type from t_docm where project_type is not null group by project_type
    </select>
    <delete id="delete">
        delete from t_docm where id = #{id}
    </delete>
</mapper>